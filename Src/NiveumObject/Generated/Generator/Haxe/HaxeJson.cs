//==========================================================================
//
//  Notice:      This file is automatically generated.
//               Please don't modify this file.
//
//==========================================================================

#nullable enable
#pragma warning disable CS8618

using System;
using System.Collections.Generic;
using System.Linq;
using Firefly;
using Boolean = System.Boolean;
using String = System.String;
using Type = System.Type;
using Int = System.Int32;
using Real = System.Double;
using Byte = System.Byte;
using UInt8 = System.Byte;
using UInt16 = System.UInt16;
using UInt32 = System.UInt32;
using UInt64 = System.UInt64;
using Int8 = System.SByte;
using Int16 = System.Int16;
using Int32 = System.Int32;
using Int64 = System.Int64;
using Float32 = System.Single;
using Float64 = System.Double;

namespace Niveum.ObjectSchema.HaxeJson
{
    partial class Templates
    {
        private IEnumerable<String> Begin()
        {
            yield return "";
        }
        private IEnumerable<String> Combine(IEnumerable<String> Left, String Right)
        {
            foreach (var vLeft in Left)
            {
                yield return vLeft + Right;
            }
        }
        private IEnumerable<String> Combine(IEnumerable<String> Left, Object Right)
        {
            foreach (var vLeft in Left)
            {
                yield return vLeft + Convert.ToString(Right, System.Globalization.CultureInfo.InvariantCulture);
            }
        }
        private IEnumerable<String> Combine(IEnumerable<String> Left, IEnumerable<String> Right)
        {
            foreach (var vLeft in Left)
            {
                foreach (var vRight in Right)
                {
                    yield return vLeft + vRight;
                }
            }
        }
        private IEnumerable<String> Combine<T>(IEnumerable<String> Left, IEnumerable<T> Right)
        {
            foreach (var vLeft in Left)
            {
                foreach (var vRight in Right)
                {
                    yield return vLeft + Convert.ToString(vRight, System.Globalization.CultureInfo.InvariantCulture);
                }
            }
        }
        private IEnumerable<String> GetEscapedIdentifier(IEnumerable<String> IdentifierValues)
        {
            foreach (var Identifier in IdentifierValues)
            {
                yield return GetEscapedIdentifier(Identifier);
            }
        }
        public IEnumerable<String> IJsonSender()
        {
            yield return "interface IJsonSender";
            yield return "{";
            yield return "    function send(commandName : String, commandHash : String, parameters : String) : Void;";
            yield return "}";
        }
        public IEnumerable<String> JsonSerializationClient(UInt64 Hash, List<TypeDef> Commands, ISchemaClosureGenerator SchemaClosureGenerator, String NamespaceName)
        {
            yield return "private class ApplicationClient implements IApplicationClient";
            yield return "{";
            yield return "    public var s : IJsonSender;";
            yield return "    public var clientCommandCallbacks : Map<String, Array<{commandHash : String, _callback : String -> Void}>>;";
            yield return "";
            yield return "    public function new()";
            yield return "    {";
            yield return "    }";
            yield return "";
            yield return "    public var hash(get, null) : String;";
            yield return "    public function get_hash() : String";
            yield return "    {";
            foreach (var _Line in Combine(Combine(Combine(Begin(), "        return \""), Hash.ToString("X16", System.Globalization.CultureInfo.InvariantCulture)), "\";"))
            {
                yield return _Line;
            }
            yield return "    }";
            yield return "";
            yield return "    public function dequeueCallback(commandName : String) : Void";
            yield return "    {";
            yield return "        clientCommandCallbacks.get(commandName).shift();";
            yield return "    }";
            yield return "";
            yield return "    private function addCallback(commandName : String, commandHash : String, _callback : String -> Void) : Void";
            yield return "    {";
            yield return "        if (clientCommandCallbacks.exists(commandName))";
            yield return "        {";
            yield return "            clientCommandCallbacks.get(commandName).push({commandHash : commandHash, _callback : _callback});";
            yield return "        }";
            yield return "        else";
            yield return "        {";
            yield return "            var q = new Array<{commandHash : String, _callback : String -> Void}>();";
            yield return "            q.push({commandHash : commandHash, _callback : _callback});";
            yield return "            clientCommandCallbacks.set(commandName, q);";
            yield return "        }";
            yield return "    }";
            yield return "";
            foreach (var c in Commands)
            {
                if (c.OnClientCommand)
                {
                    var CommandNameString = GetEscapedStringLiteral(c.ClientCommand.FullName());
                    var RequestTypeString = GetSuffixedTypeString(c.ClientCommand.Name, c.ClientCommand.Version, "Request", NamespaceName);
                    var ReplyTypeString = GetSuffixedTypeString(c.ClientCommand.Name, c.ClientCommand.Version, "Reply", NamespaceName);
                    var RequestName = GetSuffixedTypeName(c.ClientCommand.Name, c.ClientCommand.Version, "Request", NamespaceName);
                    var ReplyName = GetSuffixedTypeName(c.ClientCommand.Name, c.ClientCommand.Version, "Reply", NamespaceName);
                    var Name = c.ClientCommand.GetTypeSpec().SimpleName(NamespaceName);
                    var CommandHash = ((UInt32)(SchemaClosureGenerator.GetSubSchema(new List<TypeDef> { c }, new List<TypeSpec> { }).GetNonversioned().GetNonattributed().Hash().Bits(31, 0))).ToString("X8", System.Globalization.CultureInfo.InvariantCulture);
                    foreach (var _Line in Combine(Combine(Combine(Combine(Combine(Combine(Combine(Begin(), "public function "), GetEscapedIdentifier(LowercaseCamelize(Name))), "(r : "), RequestTypeString), ", _callback : "), ReplyTypeString), " -> Void) : Void"))
                    {
                        yield return _Line == "" ? "" : "    " + _Line;
                    }
                    yield return "    " + "{";
                    foreach (var _Line in Combine(Combine(Combine(Begin(), "    var request = Json.stringify(JsonTranslator."), GetEscapedIdentifier(Combine(Combine(Begin(), LowercaseCamelize(RequestName)), "ToJson"))), "(r));"))
                    {
                        yield return _Line == "" ? "" : "    " + _Line;
                    }
                    foreach (var _Line in Combine(Combine(Combine(Combine(Combine(Combine(Combine(Begin(), "    addCallback("), CommandNameString), ", \""), CommandHash), "\", function(parameters) { return _callback(JsonTranslator."), GetEscapedIdentifier(Combine(Combine(Begin(), LowercaseCamelize(ReplyName)), "FromJson"))), "(Json.parse(parameters))); });"))
                    {
                        yield return _Line == "" ? "" : "    " + _Line;
                    }
                    foreach (var _Line in Combine(Combine(Combine(Combine(Combine(Begin(), "    s.send("), CommandNameString), ", \""), CommandHash), "\", request);"))
                    {
                        yield return _Line == "" ? "" : "    " + _Line;
                    }
                    yield return "    " + "}";
                }
                else if (c.OnServerCommand)
                {
                    var Name = c.ServerCommand.GetTypeSpec().SimpleName(NamespaceName);
                    var EventTypeString = GetSuffixedTypeString(c.ServerCommand.Name, c.ServerCommand.Version, "Event", NamespaceName);
                    foreach (var _Line in Combine(Combine(Combine(Combine(Combine(Begin(), "public var "), GetEscapedIdentifier(LowercaseCamelize(Name))), " : "), EventTypeString), " -> Void;"))
                    {
                        yield return _Line == "" ? "" : "    " + _Line;
                    }
                    foreach (var _Line in Combine(Combine(Combine(Combine(Combine(Combine(Combine(Combine(Combine(Begin(), "public function "), GetEscapedIdentifier(Combine(Combine(Begin(), "raise"), Name))), "(e : "), EventTypeString), ") : Void { if ("), GetEscapedIdentifier(LowercaseCamelize(Name))), " != null) { "), GetEscapedIdentifier(LowercaseCamelize(Name))), "(e); } }"))
                    {
                        yield return _Line == "" ? "" : "    " + _Line;
                    }
                }
            }
            yield return "}";
            yield return "";
            yield return "@:final";
            yield return "class JsonSerializationClient";
            yield return "{";
            yield return "    public function getApplicationClient() : IApplicationClient";
            yield return "    {";
            yield return "        return c;";
            yield return "    }";
            yield return "";
            yield return "    private var c : ApplicationClient;";
            yield return "    private var serverCommands : Map<String, {commandHash : String, _callback : String -> Void}>;";
            yield return "";
            yield return "    public function new(s : IJsonSender)";
            yield return "    {";
            yield return "        c = new ApplicationClient();";
            yield return "        c.s = s;";
            yield return "        c.clientCommandCallbacks = new Map<String, Array<{commandHash : String, _callback : String -> Void}>>();";
            yield return "        serverCommands = new Map<String, {commandHash : String, _callback : String -> Void}>();";
            foreach (var c in Commands)
            {
                if (c.OnServerCommand)
                {
                    var CommandNameString = GetEscapedStringLiteral(c.ServerCommand.FullName());
                    var EventTypeString = GetSuffixedTypeString(c.ServerCommand.Name, c.ServerCommand.Version, "Event", NamespaceName);
                    var EventName = GetSuffixedTypeName(c.ServerCommand.Name, c.ServerCommand.Version, "Event", NamespaceName);
                    var Name = c.ServerCommand.GetTypeSpec().SimpleName(NamespaceName);
                    var CommandHash = ((UInt32)(SchemaClosureGenerator.GetSubSchema(new List<TypeDef> { c }, new List<TypeSpec> { }).GetNonversioned().GetNonattributed().Hash().Bits(31, 0))).ToString("X8", System.Globalization.CultureInfo.InvariantCulture);
                    foreach (var _Line in Combine(Combine(Combine(Combine(Combine(Combine(Combine(Combine(Combine(Begin(), "serverCommands.set("), CommandNameString), ", {commandHash : \""), CommandHash), "\", _callback : function(parameters) { c."), GetEscapedIdentifier(Combine(Combine(Begin(), "raise"), Name))), "(JsonTranslator."), GetEscapedIdentifier(Combine(Combine(Begin(), LowercaseCamelize(EventName)), "FromJson"))), "(Json.parse(parameters))); }});"))
                    {
                        yield return _Line == "" ? "" : "        " + _Line;
                    }
                }
            }
            yield return "    }";
            yield return "";
            yield return "    public function handleResult(commandName : String, commandHash : String, parameters : String) : Void";
            yield return "    {";
            yield return "        if (c.clientCommandCallbacks.exists(commandName))";
            yield return "        {";
            yield return "            var q = c.clientCommandCallbacks.get(commandName);";
            yield return "            if (q.length == 0)";
            yield return "            {";
            yield return "                throw \"InvalidOperationException: \" + commandName + \"@\" + commandHash;";
            yield return "            }";
            yield return "            var callbackPair = q[0];";
            yield return "            if (callbackPair.commandHash != commandHash)";
            yield return "            {";
            yield return "                throw \"InvalidOperationException: \" + commandName + \"@\" + commandHash;";
            yield return "            }";
            yield return "            q.shift();";
            yield return "            var _callback = callbackPair._callback;";
            yield return "            _callback(parameters);";
            yield return "            return;";
            yield return "        }";
            yield return "";
            yield return "        if (serverCommands.exists(commandName))";
            yield return "        {";
            yield return "            var callbackPair = serverCommands.get(commandName);";
            yield return "            if (callbackPair.commandHash != commandHash)";
            yield return "            {";
            yield return "                throw \"InvalidOperationException: \" + commandName + \"@\" + commandHash;";
            yield return "            }";
            yield return "            var _callback = callbackPair._callback;";
            yield return "            _callback(parameters);";
            yield return "            return;";
            yield return "        }";
            yield return "";
            yield return "        throw \"InvalidOperationException: \" + commandName + \"@\" + commandHash;";
            yield return "    }";
            yield return "}";
        }
        public IEnumerable<String> JsonTranslator(Schema Schema, String NamespaceName)
        {
            yield return "@:final";
            yield return "class JsonTranslator /* static */";
            yield return "{";
            yield return "    private static function hasField(o : Dynamic, field : String) : Boolean";
            yield return "    {";
            yield return "        return Reflect.hasField(o, field);";
            yield return "    }";
            yield return "    private static function getField(o : Dynamic, field : String) : Dynamic";
            yield return "    {";
            yield return "        if (!Reflect.hasField(o, field)) { throw \"InvalidOperation\"; }";
            yield return "        return Reflect.field(o, field);";
            yield return "    }";
            yield return "    private static function setField(o : Dynamic, field : String, value : Dynamic) : Void";
            yield return "    {";
            yield return "        Reflect.setField(o, field, value);";
            yield return "    }";
            yield return "";
            foreach (var _Line in Combine(Combine(Begin(), "    "), GetJsonTranslatorSerializers(Schema, NamespaceName)))
            {
                yield return _Line;
            }
            yield return "}";
        }
        public IEnumerable<String> JsonTranslator_Primitive_Unit()
        {
            yield return "public static function unitFromJson(j : Dynamic) : Unit";
            yield return "{";
            yield return "    return {};";
            yield return "}";
            yield return "public static function unitToJson(v : Unit) : Dynamic";
            yield return "{";
            yield return "    return {};";
            yield return "}";
        }
        public IEnumerable<String> JsonTranslator_Primitive_Boolean()
        {
            yield return "public static function booleanFromJson(j : Dynamic) : Boolean";
            yield return "{";
            yield return "    return cast(j, Boolean);";
            yield return "}";
            yield return "public static function booleanToJson(v : Boolean) : Dynamic";
            yield return "{";
            yield return "    return v;";
            yield return "}";
        }
        public IEnumerable<String> JsonTranslator_Primitive_String()
        {
            yield return "public static function stringFromJson(j : Dynamic) : String";
            yield return "{";
            yield return "    return cast(j, String);";
            yield return "}";
            yield return "public static function stringToJson(v : String) : Dynamic";
            yield return "{";
            yield return "    return v;";
            yield return "}";
        }
        public IEnumerable<String> JsonTranslator_Primitive_Int()
        {
            yield return "public static function intFromJson(j : Dynamic) : Int";
            yield return "{";
            yield return "    return cast(j, Int);";
            yield return "}";
            yield return "public static function intToJson(v : Int)";
            yield return "{";
            yield return "    return v;";
            yield return "}";
        }
        public IEnumerable<String> JsonTranslator_Primitive_Real()
        {
            yield return "public static function realFromJson(j : Dynamic) : Real";
            yield return "{";
            yield return "    return cast(j, Real);";
            yield return "}";
            yield return "public static function realToJson(v : Real) : Dynamic";
            yield return "{";
            yield return "    return v;";
            yield return "}";
        }
        public IEnumerable<String> JsonTranslator_Primitive_Byte()
        {
            yield return "public static function byteFromJson(j : Dynamic) : Byte";
            yield return "{";
            yield return "    return cast(j, Byte);";
            yield return "}";
            yield return "public static function byteToJson(v : Byte) : Dynamic";
            yield return "{";
            yield return "    return v;";
            yield return "}";
        }
        public IEnumerable<String> JsonTranslator_Primitive_UInt8()
        {
            yield return "public static function uint8FromJson(j : Dynamic) : UInt8";
            yield return "{";
            yield return "    return cast(j, UInt8);";
            yield return "}";
            yield return "public static function uint8ToJson(v : UInt8) : Dynamic";
            yield return "{";
            yield return "    return v;";
            yield return "}";
        }
        public IEnumerable<String> JsonTranslator_Primitive_UInt16()
        {
            yield return "public static function uint16FromJson(j : Dynamic) : UInt16";
            yield return "{";
            yield return "    return cast(j, UInt16);";
            yield return "}";
            yield return "public static function uint16ToJson(v : UInt16) : Dynamic";
            yield return "{";
            yield return "    return v;";
            yield return "}";
        }
        public IEnumerable<String> JsonTranslator_Primitive_UInt32()
        {
            yield return "public static function uint32FromJson(j : Dynamic) : UInt32";
            yield return "{";
            yield return "    return cast(j, UInt32);";
            yield return "}";
            yield return "public static function uint32ToJson(v : UInt32) : Dynamic";
            yield return "{";
            yield return "    return v;";
            yield return "}";
        }
        public IEnumerable<String> JsonTranslator_Primitive_UInt64()
        {
            yield return "public static function uint64FromJson(j : Dynamic) : UInt64";
            yield return "{";
            yield return "    return cast(int64FromJson(j), UInt64);";
            yield return "}";
            yield return "public static function uint64ToJson(v : UInt64) : Dynamic";
            yield return "{";
            yield return "    return int64ToJson(cast(v, Int64));";
            yield return "}";
        }
        public IEnumerable<String> JsonTranslator_Primitive_Int8()
        {
            yield return "public static function int8FromJson(j : Dynamic) : Int8";
            yield return "{";
            yield return "    return cast(j, Int8);";
            yield return "}";
            yield return "public static function int8ToJson(v : Int8) : Dynamic";
            yield return "{";
            yield return "    return v;";
            yield return "}";
        }
        public IEnumerable<String> JsonTranslator_Primitive_Int16()
        {
            yield return "public static function int16FromJson(j : Dynamic) : Int16";
            yield return "{";
            yield return "    return cast(j, Int16);";
            yield return "}";
            yield return "public static function int16ToJson(v : Int16) : Dynamic";
            yield return "{";
            yield return "    return v;";
            yield return "}";
        }
        public IEnumerable<String> JsonTranslator_Primitive_Int32()
        {
            yield return "public static function int32FromJson(j : Dynamic) : Int32";
            yield return "{";
            yield return "    return cast(j, Int32);";
            yield return "}";
            yield return "public static function int32ToJson(v : Int32) : Dynamic";
            yield return "{";
            yield return "    return v;";
            yield return "}";
        }
        public IEnumerable<String> JsonTranslator_Primitive_Int64()
        {
            yield return "public static function int64FromJson(j : Dynamic) : Int64";
            yield return "{";
            yield return "    return Int64.fromFloat(cast(j, Float));";
            yield return "}";
            yield return "public static function int64ToJson(v : Int64) : Dynamic";
            yield return "{";
            yield return "    return v.high * 4294967296.0 + v.low;";
            yield return "}";
        }
        public IEnumerable<String> JsonTranslator_Primitive_Float32()
        {
            yield return "public static function float32FromJson(j : Dynamic) : Float32";
            yield return "{";
            yield return "    return cast(j, Float32);";
            yield return "}";
            yield return "public static function float32ToJson(v : Float32) : Dynamic";
            yield return "{";
            yield return "    return v;";
            yield return "}";
        }
        public IEnumerable<String> JsonTranslator_Primitive_Float64()
        {
            yield return "public static function float64FromJson(j : Dynamic) : Float64";
            yield return "{";
            yield return "    return cast(j, Float64);";
            yield return "}";
            yield return "public static function float64ToJson(v : Float64) : Dynamic";
            yield return "{";
            yield return "    return v;";
            yield return "}";
        }
        public IEnumerable<String> JsonTranslator_Primitive_Type()
        {
            yield return "public static function typeFromJson(j : Dynamic) : Void";
            yield return "{";
            yield return "    throw \"NotSupportedException\";";
            yield return "}";
            yield return "public static function typeToJson(v : Dynamic) : Void";
            yield return "{";
            yield return "    throw \"NotSupportedException\";";
            yield return "}";
        }
        public IEnumerable<String> JsonTranslator_Alias(AliasDef a, String NamespaceName)
        {
            foreach (var _Line in Combine(Begin(), JsonTranslator_Alias(a.GetTypeSpec().SimpleName(NamespaceName), GetTypeString(a.GetTypeSpec(), NamespaceName), a.Type, NamespaceName)))
            {
                yield return _Line;
            }
        }
        public IEnumerable<String> JsonTranslator_Alias(String Name, String TypeString, TypeSpec ValueType, String NamespaceName)
        {
            var ValueSimpleName = ValueType.SimpleName(NamespaceName);
            foreach (var _Line in Combine(Combine(Combine(Combine(Begin(), "public static function "), GetEscapedIdentifier(Combine(Combine(Begin(), LowercaseCamelize(Name)), "FromJson"))), "(j : Dynamic) : "), TypeString))
            {
                yield return _Line;
            }
            yield return "{";
            foreach (var _Line in Combine(Combine(Combine(Begin(), "    return "), GetEscapedIdentifier(Combine(Combine(Begin(), LowercaseCamelize(ValueSimpleName)), "FromJson"))), "(j);"))
            {
                yield return _Line;
            }
            yield return "}";
            foreach (var _Line in Combine(Combine(Combine(Combine(Combine(Begin(), "public static function "), GetEscapedIdentifier(Combine(Combine(Begin(), LowercaseCamelize(Name)), "ToJson"))), "(o : "), TypeString), ") : Dynamic"))
            {
                yield return _Line;
            }
            yield return "{";
            foreach (var _Line in Combine(Combine(Combine(Begin(), "    return "), GetEscapedIdentifier(Combine(Combine(Begin(), LowercaseCamelize(ValueSimpleName)), "ToJson"))), "(o);"))
            {
                yield return _Line;
            }
            yield return "}";
        }
        public IEnumerable<String> JsonTranslator_Record(RecordDef r, String NamespaceName)
        {
            foreach (var _Line in Combine(Begin(), JsonTranslator_Record(r.GetTypeSpec().SimpleName(NamespaceName), GetTypeString(r.GetTypeSpec(), NamespaceName), r.Fields, NamespaceName)))
            {
                yield return _Line;
            }
        }
        public IEnumerable<String> JsonTranslator_Record(String Name, String TypeString, List<VariableDef> Fields, String NamespaceName)
        {
            foreach (var _Line in Combine(Combine(Combine(Combine(Begin(), "public static function "), GetEscapedIdentifier(Combine(Combine(Begin(), LowercaseCamelize(Name)), "FromJson"))), "(j : Dynamic) : "), TypeString))
            {
                yield return _Line;
            }
            yield return "{";
            yield return "    return";
            yield return "    {";
            foreach (var a in Fields)
            {
                foreach (var _Line in Combine(Combine(Combine(Combine(Combine(Combine(Begin(), GetEscapedIdentifier(LowercaseCamelize(a.Name))), " : "), GetEscapedIdentifier(Combine(Combine(Begin(), LowercaseCamelize(a.Type.SimpleName(NamespaceName))), "FromJson"))), "(getField(j, "), GetEscapedStringLiteral(LowercaseCamelize(a.Name))), ")),"))
                {
                    yield return _Line == "" ? "" : "        " + _Line;
                }
            }
            yield return "    };";
            yield return "}";
            foreach (var _Line in Combine(Combine(Combine(Combine(Combine(Begin(), "public static function "), GetEscapedIdentifier(Combine(Combine(Begin(), LowercaseCamelize(Name)), "ToJson"))), "(o : "), TypeString), ") : Dynamic"))
            {
                yield return _Line;
            }
            yield return "{";
            yield return "    var j : Dynamic = {};";
            foreach (var a in Fields)
            {
                foreach (var _Line in Combine(Combine(Combine(Combine(Combine(Combine(Combine(Begin(), "setField(j, "), GetEscapedStringLiteral(LowercaseCamelize(a.Name))), ", "), GetEscapedIdentifier(Combine(Combine(Begin(), LowercaseCamelize(a.Type.SimpleName(NamespaceName))), "ToJson"))), "(o."), GetEscapedIdentifier(LowercaseCamelize(a.Name))), "));"))
                {
                    yield return _Line == "" ? "" : "    " + _Line;
                }
            }
            yield return "    return j;";
            yield return "}";
        }
        public IEnumerable<String> JsonTranslator_TaggedUnion(TaggedUnionDef tu, String NamespaceName)
        {
            foreach (var _Line in Combine(Begin(), JsonTranslator_TaggedUnion(tu.GetTypeSpec().SimpleName(NamespaceName), GetTypeString(tu.GetTypeSpec(), NamespaceName), tu.Alternatives, NamespaceName)))
            {
                yield return _Line;
            }
        }
        public IEnumerable<String> JsonTranslator_TaggedUnion(String Name, String TypeString, List<VariableDef> Alternatives, String NamespaceName)
        {
            foreach (var _Line in Combine(Combine(Combine(Combine(Begin(), "public static function "), GetEscapedIdentifier(Combine(Combine(Begin(), LowercaseCamelize(Name)), "FromJson"))), "(j : Dynamic) : "), TypeString))
            {
                yield return _Line;
            }
            yield return "{";
            foreach (var a in Alternatives)
            {
                if (a.Type.OnTypeRef && a.Type.TypeRef.NameMatches("Unit"))
                {
                    foreach (var _Line in Combine(Combine(Combine(Begin(), "if (hasField(j, "), GetEscapedStringLiteral(LowercaseCamelize(a.Name))), "))"))
                    {
                        yield return _Line == "" ? "" : "    " + _Line;
                    }
                    yield return "    " + "{";
                    foreach (var _Line in Combine(Combine(Combine(Combine(Combine(Begin(), "    return "), TypeString), "."), GetEscapedIdentifier(LowercaseCamelize(a.Name))), ";"))
                    {
                        yield return _Line == "" ? "" : "    " + _Line;
                    }
                    yield return "    " + "}";
                }
                else
                {
                    foreach (var _Line in Combine(Combine(Combine(Begin(), "if (hasField(j, "), GetEscapedStringLiteral(LowercaseCamelize(a.Name))), "))"))
                    {
                        yield return _Line == "" ? "" : "    " + _Line;
                    }
                    yield return "    " + "{";
                    foreach (var _Line in Combine(Combine(Combine(Combine(Combine(Begin(), "    var v = "), GetEscapedIdentifier(Combine(Combine(Begin(), LowercaseCamelize(a.Type.SimpleName(NamespaceName))), "FromJson"))), "(getField(j, "), GetEscapedStringLiteral(LowercaseCamelize(a.Name))), "));"))
                    {
                        yield return _Line == "" ? "" : "    " + _Line;
                    }
                    foreach (var _Line in Combine(Combine(Combine(Combine(Combine(Begin(), "    return "), TypeString), "."), GetEscapedIdentifier(LowercaseCamelize(a.Name))), "(v);"))
                    {
                        yield return _Line == "" ? "" : "    " + _Line;
                    }
                    yield return "    " + "}";
                }
            }
            yield return "    throw \"InvalidOperation\";";
            yield return "}";
            foreach (var _Line in Combine(Combine(Combine(Combine(Combine(Begin(), "public static function "), GetEscapedIdentifier(Combine(Combine(Begin(), LowercaseCamelize(Name)), "ToJson"))), "(o : "), TypeString), ") : Dynamic"))
            {
                yield return _Line;
            }
            yield return "{";
            yield return "    var j : Dynamic = {};";
            yield return "    switch (o)";
            yield return "    {";
            foreach (var a in Alternatives)
            {
                if (a.Type.OnTypeRef && a.Type.TypeRef.NameMatches("Unit"))
                {
                    foreach (var _Line in Combine(Combine(Combine(Begin(), "case "), GetEscapedIdentifier(LowercaseCamelize(a.Name))), ":"))
                    {
                        yield return _Line == "" ? "" : "    " + _Line;
                    }
                    foreach (var _Line in Combine(Combine(Combine(Begin(), "    setField(j, "), GetEscapedStringLiteral(LowercaseCamelize(a.Name))), ", unitToJson({}));"))
                    {
                        yield return _Line == "" ? "" : "    " + _Line;
                    }
                }
                else
                {
                    foreach (var _Line in Combine(Combine(Combine(Begin(), "case "), GetEscapedIdentifier(LowercaseCamelize(a.Name))), "(v):"))
                    {
                        yield return _Line == "" ? "" : "    " + _Line;
                    }
                    foreach (var _Line in Combine(Combine(Combine(Combine(Combine(Begin(), "    setField(j, "), GetEscapedStringLiteral(LowercaseCamelize(a.Name))), ", "), GetEscapedIdentifier(Combine(Combine(Begin(), LowercaseCamelize(a.Type.SimpleName(NamespaceName))), "ToJson"))), "(v));"))
                    {
                        yield return _Line == "" ? "" : "    " + _Line;
                    }
                }
            }
            yield return "    }";
            yield return "    return j;";
            yield return "}";
        }
        public IEnumerable<String> JsonTranslator_Enum(EnumDef e, String NamespaceName)
        {
            var Name = e.GetTypeSpec().SimpleName(NamespaceName);
            foreach (var _Line in Combine(Combine(Combine(Combine(Begin(), "public static function "), GetEscapedIdentifier(Combine(Combine(Begin(), LowercaseCamelize(Name)), "FromJson"))), "(j : Dynamic) : "), GetTypeString(e.UnderlyingType, NamespaceName)))
            {
                yield return _Line;
            }
            yield return "{";
            foreach (var _Line in Combine(Combine(Combine(Begin(), "    return cast(j, "), GetTypeString(e.UnderlyingType, NamespaceName)), ");"))
            {
                yield return _Line;
            }
            yield return "}";
            foreach (var _Line in Combine(Combine(Combine(Combine(Combine(Begin(), "public static function "), GetEscapedIdentifier(Combine(Combine(Begin(), LowercaseCamelize(Name)), "ToJson"))), "(o : "), GetTypeString(e.UnderlyingType, NamespaceName)), ") : Dynamic"))
            {
                yield return _Line;
            }
            yield return "{";
            yield return "    return o;";
            yield return "}";
        }
        public IEnumerable<String> JsonTranslator_ClientCommand(ClientCommandDef c, String NamespaceName)
        {
            foreach (var _Line in Combine(Begin(), JsonTranslator_Record(GetSuffixedTypeName(c.Name, c.Version, "Request", NamespaceName), GetSuffixedTypeString(c.Name, c.Version, "Request", NamespaceName), c.OutParameters, NamespaceName)))
            {
                yield return _Line;
            }
            foreach (var _Line in Combine(Begin(), JsonTranslator_TaggedUnion(GetSuffixedTypeName(c.Name, c.Version, "Reply", NamespaceName), GetSuffixedTypeString(c.Name, c.Version, "Reply", NamespaceName), c.InParameters, NamespaceName)))
            {
                yield return _Line;
            }
        }
        public IEnumerable<String> JsonTranslator_ServerCommand(ServerCommandDef c, String NamespaceName)
        {
            foreach (var _Line in Combine(Begin(), JsonTranslator_Record(GetSuffixedTypeName(c.Name, c.Version, "Event", NamespaceName), GetSuffixedTypeString(c.Name, c.Version, "Event", NamespaceName), c.OutParameters, NamespaceName)))
            {
                yield return _Line;
            }
        }
        public IEnumerable<String> JsonTranslator_Tuple(TypeSpec tp, String NamespaceName)
        {
            var SimpleName = tp.SimpleName(NamespaceName);
            var TypeString = GetTypeString(tp, NamespaceName);
            foreach (var _Line in Combine(Combine(Combine(Combine(Begin(), "public static function "), GetEscapedIdentifier(Combine(Combine(Begin(), LowercaseCamelize(SimpleName)), "FromJson"))), "(j : Dynamic) : "), TypeString))
            {
                yield return _Line;
            }
            yield return "{";
            yield return "    var ja = cast(j, Array<Dynamic>);";
            yield return "    return";
            yield return "    {";
            {
                int k = 0;
                foreach (var t in tp.Tuple)
                {
                    foreach (var _Line in Combine(Combine(Combine(Combine(Combine(Combine(Begin(), GetEscapedIdentifier(Combine(Combine(Begin(), "item"), k))), " : "), GetEscapedIdentifier(Combine(Combine(Begin(), LowercaseCamelize(t.SimpleName(NamespaceName))), "FromJson"))), "(ja["), k), "]),"))
                    {
                        yield return _Line == "" ? "" : "        " + _Line;
                    }
                    k += 1;
                }
            }
            yield return "    };";
            yield return "}";
            foreach (var _Line in Combine(Combine(Combine(Combine(Combine(Begin(), "public static function "), GetEscapedIdentifier(Combine(Combine(Begin(), LowercaseCamelize(SimpleName)), "ToJson"))), "(t : "), TypeString), ") : Dynamic"))
            {
                yield return _Line;
            }
            yield return "{";
            yield return "    var ja = new Array<Dynamic>();";
            {
                int k = 0;
                foreach (var t in tp.Tuple)
                {
                    foreach (var _Line in Combine(Combine(Combine(Combine(Combine(Begin(), "ja.push("), GetEscapedIdentifier(Combine(Combine(Begin(), LowercaseCamelize(t.SimpleName(NamespaceName))), "ToJson"))), "(t."), GetEscapedIdentifier(Combine(Combine(Begin(), "item"), k))), "));"))
                    {
                        yield return _Line == "" ? "" : "    " + _Line;
                    }
                    k += 1;
                }
            }
            yield return "    return ja;";
            yield return "}";
        }
        public IEnumerable<String> JsonTranslator_Optional(TypeSpec o, String NamespaceName)
        {
            var SimpleName = o.SimpleName(NamespaceName);
            var TypeString = GetTypeString(o, NamespaceName);
            var ElementSimpleName = o.GenericTypeSpec.ParameterValues.Single().SimpleName(NamespaceName);
            foreach (var _Line in Combine(Combine(Combine(Combine(Begin(), "public static function "), GetEscapedIdentifier(Combine(Combine(Begin(), LowercaseCamelize(SimpleName)), "FromJson"))), "(j : Dynamic) : "), TypeString))
            {
                yield return _Line;
            }
            yield return "{";
            yield return "    if (hasField(j, \"none\"))";
            yield return "    {";
            yield return "        return null;";
            yield return "    }";
            yield return "    if (hasField(j, \"some\"))";
            yield return "    {";
            foreach (var _Line in Combine(Combine(Combine(Begin(), "        var v = "), GetEscapedIdentifier(Combine(Combine(Begin(), LowercaseCamelize(ElementSimpleName)), "FromJson"))), "(getField(j, \"some\"));"))
            {
                yield return _Line;
            }
            yield return "        return v;";
            yield return "    }";
            yield return "    throw \"InvalidOperation\";";
            yield return "}";
            foreach (var _Line in Combine(Combine(Combine(Combine(Combine(Begin(), "public static function "), GetEscapedIdentifier(Combine(Combine(Begin(), LowercaseCamelize(SimpleName)), "ToJson"))), "(o : "), TypeString), ") : Dynamic"))
            {
                yield return _Line;
            }
            yield return "{";
            yield return "    var j : Dynamic = {};";
            yield return "    if (o == null)";
            yield return "    {";
            yield return "        setField(j, \"none\", unitToJson({}));";
            yield return "    }";
            yield return "    else";
            yield return "    {";
            foreach (var _Line in Combine(Combine(Combine(Begin(), "        setField(j, \"some\", "), GetEscapedIdentifier(Combine(Combine(Begin(), LowercaseCamelize(ElementSimpleName)), "ToJson"))), "(o));"))
            {
                yield return _Line;
            }
            yield return "    }";
            yield return "    return j;";
            yield return "}";
        }
        public IEnumerable<String> JsonTranslator_List(TypeSpec l, String NamespaceName)
        {
            var SimpleName = l.SimpleName(NamespaceName);
            var TypeString = GetTypeString(l, NamespaceName);
            var ElementSimpleName = l.GenericTypeSpec.ParameterValues.Single().SimpleName(NamespaceName);
            foreach (var _Line in Combine(Combine(Combine(Combine(Begin(), "public static function "), GetEscapedIdentifier(Combine(Combine(Begin(), LowercaseCamelize(SimpleName)), "FromJson"))), "(j : Dynamic) : "), TypeString))
            {
                yield return _Line;
            }
            yield return "{";
            yield return "    var ja = cast(j, Array<Dynamic>);";
            foreach (var _Line in Combine(Combine(Combine(Begin(), "    var a = new "), TypeString), "();"))
            {
                yield return _Line;
            }
            yield return "    for (e in ja)";
            yield return "    {";
            foreach (var _Line in Combine(Combine(Combine(Begin(), "        a.push("), GetEscapedIdentifier(Combine(Combine(Begin(), LowercaseCamelize(ElementSimpleName)), "FromJson"))), "(e));"))
            {
                yield return _Line;
            }
            yield return "    }";
            yield return "    return a;";
            yield return "}";
            foreach (var _Line in Combine(Combine(Combine(Combine(Combine(Begin(), "public static function "), GetEscapedIdentifier(Combine(Combine(Begin(), LowercaseCamelize(SimpleName)), "ToJson"))), "(c : "), TypeString), ") : Dynamic"))
            {
                yield return _Line;
            }
            yield return "{";
            yield return "    var ja = new Array<Dynamic>();";
            yield return "    for (e in c)";
            yield return "    {";
            foreach (var _Line in Combine(Combine(Combine(Begin(), "        ja.push("), GetEscapedIdentifier(Combine(Combine(Begin(), LowercaseCamelize(ElementSimpleName)), "ToJson"))), "(e));"))
            {
                yield return _Line;
            }
            yield return "    }";
            yield return "    return ja;";
            yield return "}";
        }
        public IEnumerable<String> JsonTranslator_Set(TypeSpec l, String NamespaceName)
        {
            var SimpleName = l.SimpleName(NamespaceName);
            var TypeString = GetTypeString(l, NamespaceName);
            var ElementSimpleName = l.GenericTypeSpec.ParameterValues.Single().SimpleName(NamespaceName);
            foreach (var _Line in Combine(Combine(Combine(Combine(Begin(), "public static function "), GetEscapedIdentifier(Combine(Combine(Begin(), LowercaseCamelize(SimpleName)), "FromJson"))), "(j : Dynamic) : "), TypeString))
            {
                yield return _Line;
            }
            yield return "{";
            yield return "    var ja = cast(j, Array<Dynamic>);";
            foreach (var _Line in Combine(Combine(Combine(Begin(), "    var a = new "), TypeString), "();"))
            {
                yield return _Line;
            }
            yield return "    for (e in ja)";
            yield return "    {";
            foreach (var _Line in Combine(Combine(Combine(Begin(), "        a.set("), GetEscapedIdentifier(Combine(Combine(Begin(), LowercaseCamelize(ElementSimpleName)), "FromJson"))), "(e), {});"))
            {
                yield return _Line;
            }
            yield return "    }";
            yield return "    return a;";
            yield return "}";
            foreach (var _Line in Combine(Combine(Combine(Combine(Combine(Begin(), "public static function "), GetEscapedIdentifier(Combine(Combine(Begin(), LowercaseCamelize(SimpleName)), "ToJson"))), "(c : "), TypeString), ") : Dynamic"))
            {
                yield return _Line;
            }
            yield return "{";
            yield return "    var ja = new Array<Dynamic>();";
            yield return "    for (e in c.keys())";
            yield return "    {";
            foreach (var _Line in Combine(Combine(Combine(Begin(), "        ja.push("), GetEscapedIdentifier(Combine(Combine(Begin(), LowercaseCamelize(ElementSimpleName)), "ToJson"))), "(e));"))
            {
                yield return _Line;
            }
            yield return "    }";
            yield return "    return ja;";
            yield return "}";
        }
        public IEnumerable<String> JsonTranslator_Map(TypeSpec l, String NamespaceName)
        {
            var gp = l.GenericTypeSpec.ParameterValues;
            if (gp.Count != 2)
            {
                throw new ArgumentException();
            }
            var SimpleName = l.SimpleName(NamespaceName);
            var TypeString = GetTypeString(l, NamespaceName);
            var KeySimpleName = gp[0].SimpleName(NamespaceName);
            var ValueSimpleName = gp[1].SimpleName(NamespaceName);
            foreach (var _Line in Combine(Combine(Combine(Combine(Begin(), "public static function "), GetEscapedIdentifier(Combine(Combine(Begin(), LowercaseCamelize(SimpleName)), "FromJson"))), "(j : Dynamic) : "), TypeString))
            {
                yield return _Line;
            }
            yield return "{";
            yield return "    var ja = cast(j, Array<Dynamic>);";
            foreach (var _Line in Combine(Combine(Combine(Begin(), "    var a = new "), TypeString), "();"))
            {
                yield return _Line;
            }
            yield return "    for (e in ja)";
            yield return "    {";
            foreach (var _Line in Combine(Combine(Combine(Begin(), "        var key = "), GetEscapedIdentifier(Combine(Combine(Begin(), LowercaseCamelize(KeySimpleName)), "FromJson"))), "(getField(e, \"key\"));"))
            {
                yield return _Line;
            }
            foreach (var _Line in Combine(Combine(Combine(Begin(), "        var value = "), GetEscapedIdentifier(Combine(Combine(Begin(), LowercaseCamelize(ValueSimpleName)), "FromJson"))), "(getField(e, \"value\"));"))
            {
                yield return _Line;
            }
            yield return "        a.set(key, value);";
            yield return "    }";
            yield return "    return a;";
            yield return "}";
            foreach (var _Line in Combine(Combine(Combine(Combine(Combine(Begin(), "public static function "), GetEscapedIdentifier(Combine(Combine(Begin(), LowercaseCamelize(SimpleName)), "ToJson"))), "(c : "), TypeString), ") : Dynamic"))
            {
                yield return _Line;
            }
            yield return "{";
            yield return "    var ja = new Array<Dynamic>();";
            yield return "    for (key in c.keys())";
            yield return "    {";
            yield return "        var value = c.get(key);";
            yield return "        var jp : Dynamic = {};";
            foreach (var _Line in Combine(Combine(Combine(Begin(), "        setField(jp, \"key\", "), GetEscapedIdentifier(Combine(Combine(Begin(), LowercaseCamelize(KeySimpleName)), "ToJson"))), "(key));"))
            {
                yield return _Line;
            }
            foreach (var _Line in Combine(Combine(Combine(Begin(), "        setField(jp, \"value\", "), GetEscapedIdentifier(Combine(Combine(Begin(), LowercaseCamelize(ValueSimpleName)), "ToJson"))), "(value));"))
            {
                yield return _Line;
            }
            yield return "        ja.push(jp);";
            yield return "    }";
            yield return "    return ja;";
            yield return "}";
        }
        public IEnumerable<String> WrapModule(String NamespaceName, List<String> Imports, IEnumerable<String> Contents)
        {
            yield return "//==========================================================================";
            yield return "//";
            yield return "//  Notice:      This file is automatically generated.";
            yield return "//               Please don't modify this file.";
            yield return "//";
            yield return "//==========================================================================";
            yield return "";
            if (NamespaceName != "")
            {
                var n = String.Join(".", NamespaceName.Split('.').Select(NamespacePart => LowercaseCamelize(NamespacePart)));
                foreach (var _Line in Combine(Combine(Combine(Begin(), "package "), n), ";"))
                {
                    yield return _Line;
                }
                yield return "";
            }
            yield return "import haxe.Json;";
            foreach (var _Line in Combine(Combine(Combine(Begin(), "import "), Imports), ";"))
            {
                yield return _Line;
            }
            yield return "";
            foreach (var _Line in Combine(Begin(), Contents))
            {
                yield return _Line;
            }
            yield return "";
        }
    }
}
